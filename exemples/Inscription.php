<?php

$emailErr = $mdpErr = $champvideErr = $emailduErr = $loginduErr =  "";
 
if(isset($_POST['valider'])){
       
    function verif_champvide()
    {
    	$champs_vide=array();
         
    if (empty($_POST['login'])){
         $champs_vide[]='"login"';
    }
     
    if (empty ($_POST['nom'])){
         $champs_vide[]='"nom"';
    }
     
    if (empty ($_POST['email'])){
         $champs_vide[]='"email';
    }
         
    if (empty ($_POST['mdp'])){
         $champs_vide[]='"mdp"';
    }
     
    if (empty ($_POST['mdp_confirm'])){
         $champs_vide[]='"mdp_confirm"';
    }

	if (empty ($champs_vide)) {      
	         
	      $login=$_POST['login'];
	      $nom=$_POST['nom'];
	      $email=$_POST['email'];
	      $mdp=$_POST['mdp'];
	      $mdp_confirm=$_POST['mdp_confirm'];
	      return true;

	    } else {
	      return false;
	    }    
    } 

    function verif_email()
      {
      	$email=$_POST['email'];

		if(filter_var($email, FILTER_VALIDATE_EMAIL)) {
			return true;
		} else {
            return false;
    	}
    }

    function verif_email_deja_util()
      {
      	$email=$_POST['email'];

		try
			{
			$bdd = new PDO('mysql:host=localhost;dbname=espace_membre;charset=utf8', 'root', '');
			}
		catch(Exception $e)
			{
			die('Erreur : '.$e->getMessage());
			}

		$reponse = $bdd->query('SELECT COUNT(*) FROM inscription WHERE email ="'.$email.'"');
		$nb = $reponse->fetchColumn();
		if($nb != 0){
			return false;
		}
		else {
			return true;
		}

    }
        function verif_login_deja_util()
      {
      	$login=$_POST['login'];

		try
			{
			$bdd = new PDO('mysql:host=localhost;dbname=espace_membre;charset=utf8', 'root', '');
			}
		catch(Exception $e)
			{
			die('Erreur : '.$e->getMessage());
			}

		$reponse = $bdd->query('SELECT COUNT(*) FROM inscription WHERE login ="'.$login.'"');
		$nb = $reponse->fetchColumn();
		if($nb != 0){
			return false;
		}
		else {
			return true;
		}

    }  		

    function verif_mdp()
        {

		$mdp_hache = md5($_POST['mdp']);
		$mdpconfirm_hache = md5($_POST['mdp_confirm']);
		if ( $mdp_hache  == $mdpconfirm_hache ) 
            return true;
        else
            return false;
    	
    	}

	if ( verif_mdp()==true AND verif_champvide()==true AND verif_email_deja_util()==true AND verif_email()==true AND verif_login_deja_util()==true)  {

		    try
				{
				$bdd = new PDO('mysql:host=localhost;dbname=espace_membre;charset=utf8', 'root', '');
				}
			catch(Exception $e)
			    {
				die('Erreur : '.$e->getMessage());
				}

			$mdp_hache = md5($_POST['mdp']);
			$mdpconfirm_hache = md5($_POST['mdp_confirm']);
		  // Insertion du message à l'aide d'une requête préparée
		    $req = $bdd->prepare('INSERT INTO inscription (login,nom, email, mdp,mdp_confirm) VALUES(?, ?, ?, ?, ?)');
		    $req->execute(array($_POST['login'], $_POST['nom'],$_POST['email'], $mdp_hache, $mdpconfirm_hache));
	   
    } else {

    	if (verif_mdp()==false) {

        $mdpErr = "Les mots de passes sont différents";     

        $champs_double = array();
        $champs_double[] = "doublons";
    	}

        if (verif_email()==false) {

        $emailErr = "L'email n'est pas valide";   

        }

        if (verif_champvide()==false) {

        $champvideErr = "Le formulaire est incomplet";   

        }

        if (verif_email_deja_util()==false) {

        $emailduErr = "L'email est déjà utilisé";   

        }

        if (verif_login_deja_util()==false) {

        $loginduErr = "Le login est dèjà utilisé";   

        }           
        
    }      
        
} 
//valider
 
?>
<!DOCTYPE html>
<html lang="fr">
	<head>
		<title>Page login</title>
		<meta charset="utf-8">
		<link href="../css/Page_interaction.css" rel="stylesheet" >
		<link href="https://fonts.googleapis.com/css?family=Dosis|Archivo+Black" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Harmattan|Nunito|Berkshire+Swash|Libre+Baskerville|Permanent+Marker" rel="stylesheet">
</head>
<body>
		<div class="test">
			
			<video loop="" muted="" autoplay="" playsinline="">
				<source src="../img/inscription.mp4" type="video/mp4">
			</video>
		
			<div id="container_formi">
			
					<div id="container_inscription">
						<p style="font-size: 30px;margin-top: 10px; color:#F67059">INSCRIPTION</p>

						<form method="post"  class="form_containeri" action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]);?>  ">

							Nom <br><input type="text" name="nom" maxlength="20" style="margin:7px"> <br>

							Adresse Mail <br><input type="email" name="email" maxlength="50" style="margin:7px">
 							<br>

							Login <br><input type="text" name="login" maxlength="20" style="margin:7px"> <br>

							Mot de passe <br><input type="password" name="mdp" maxlength="20" style="margin:7px">
							<br>

							Confirmation mot de passe <br><input type="password" maxlength="20" name="mdp_confirm" style="margin:7px"> <br>

							<a href="Connexion.php" style="text-decoration: none;"><span style="text-decoration: none; color: #610C88; font-size:14px">Deja Inscrit ?</span></a> <br> 

		  					<input type="submit" value="S'inscrire" name="valider" class="connexion">
							<br>
		  					<span style="color: red;font-size: 12px;margin-bottom: 5px; font-family: Dosis"><?php echo $mdpErr;"\r\n"?></span>

		  					<span style="color: red;font-size: 12px;margin-bottom: 5px; font-family: Dosis"><?php echo $emailErr;"\r\n"?></span>	

		  					<span style="color: red;font-size: 12px;margin-bottom: 5px; font-family: Dosis"><?php echo $champvideErr;"\r\n"?></span>

		  					<span style="color: red;font-size: 12px;margin-bottom: 5px; font-family: Dosis"><?php echo $emailduErr;"\r\n"?></span>	

		  					<span style="color: red;font-size: 12px;margin-bottom: 5px; font-family: Dosis"><?php echo $loginduErr;"\r\n"?></span>				  							  					

	  					</form>
	  					
					</div>
	    </div>
    	</div>
</body>
</html>